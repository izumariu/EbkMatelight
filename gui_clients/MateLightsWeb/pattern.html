<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>MateLights</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <ul class="navigation">
      <li class="inactive">
        <a href="index.html">Text</a>
      </li>
      <li class="active">
        <a href="pattern.html">Muster</a>
      </li>
    </ul>

    <div id="interface">
    </div>

    <div id="overlay" class="overlay"></div>
    <div id="modal" class="modal">
      <img id="hidemodal" src="images/ic_keyboard_arrow_down_black_24dp_2x.png" alt="[X]" />
      <div id="lastcolorsdiv"></div>
    </div>
    <button type="button" id="send" style="float: left;">Senden</button>
    <p id="errormsg"></p>

    <script>
    var lastcolors = new Array();
    lastcolors[0] = new Color();
    lastcolors[0].setColor(11, 227, 19);
    var ccm = new ColorChooserModal();

    var width = 5;
    var height = 8;
    var bottles = new Array();

    function initGUI() {
      var interface = document.getElementById("interface");
      interface.innerHTML = "";
      for(i = 0; i < width * height; i ++) {
        bottles[i] = new MateLightsBottle();
        bottles[i].init(interface);
      }
    }

    function ColorChooserModal() {
      var overlay = document.getElementById("overlay");
      var modal = document.getElementById("modal");
      var hidemodal = document.getElementById("hidemodal");
      var lastcolorsdiv = document.getElementById("lastcolorsdiv");
      var colorindicator = new Array();
      var callback;
      var colorSlider = new ColorSlider();
      colorSlider.init(modal);
      var this_obj = this;
      hidemodal.addEventListener("click", function(event) {
        if (event.target == hidemodal) {
            this_obj.show.call(this_obj, false);
        }
      });
      overlay.addEventListener("click", function(event) {
        if (event.target == overlay) {
            this_obj.show.call(this_obj, false);
        }
      });

      this.getNewColor = function(color, listener) {
        callback = listener;
        lastcolorsdiv.innerHTML = "";
        var newColor = new ColorIndicator();
        newColor.setColor(color);
        newColor.setListener(clickcolor);
        newColor.init(lastcolorsdiv);
        newColor.setSpecial(true);
        for(i = lastcolors.length - 1; i >= 0; i --) {
          colorindicator[i] = new ColorIndicator();
          colorindicator[i].setColor(lastcolors[i]);
          colorindicator[i].setListener(clickcolor);
          colorindicator[i].init(lastcolorsdiv);
        }
        this.show(true);
      }

      function clickcolor(c) {
        console.log(c.toHexString());
        lastcolors[lastcolors.length] = c;
        this_obj.show.call(this_obj, false);
      }

      this.show = function(show) {
        if(show == true) {
          modal.style.display = "block";
          overlay.style.display = "block";
          modal.classList.remove("slidein");
          modal.classList.add("slidein");
          overlay.classList.remove("fade");
          overlay.classList.add("fade");
        }
        else {
          callback();
          modal.style.display = "none";
          overlay.style.display = "none";
        }
      }
    }

    function ColorIndicator() {
      var color = new Color();
      var div = document.createElement("div");
      var listener;
      var this_obj = this;
      div.classList.add("colorindicator");
      div.setAttribute("style", "background-color: " + color.toHexString() + ";");

      this.setListener = function(l) {
        listener = l;
      }
      div.addEventListener("click", function() {
        listener(this_obj.getColor.call(this_obj));
      });
      this.setSpecial = function(special) {
        if(special == true) {
          div.classList.remove("colorindicator");
          div.classList.add("colorindicator-special");
        }
        else {
          div.classList.remove("colorindicator-special");
          div.classList.add("colorindicator");
        }
      }
      this.setColor = function(c) {
        color = c;
        div.setAttribute("style", "background-color: " + color.toHexString() + ";");
      }
      this.getColor = function() {
        return color;
      }
      this.init = function(container) {
        container.appendChild(div);
      }
    }

    function ColorSlider() {
      var rdiv = document.createElement("div");
      var gdiv = document.createElement("div");
      var bdiv = document.createElement("div");
      rdiv.className = "colordiv";
      rdiv.setAttribute("id", "rdiv");
      gdiv.className = "colordiv";
      gdiv.setAttribute("id", "gdiv");
      bdiv.className = "colordiv";
      bdiv.setAttribute("id", "bdiv");
      this.init = function(container) {
        container.appendChild(rdiv);
        container.appendChild(gdiv);
        container.appendChild(bdiv);
      }
    }

    function MateLightsBottle() {
      var color = new Color();
      var canvas = document.createElement("canvas");
      canvas.className = "bottlecanvas";
      canvas.setAttribute("style", "width: " + 100 / width + "%;");
      var context = canvas.getContext("2d");
      var this_obj = this;

      canvas.addEventListener("click", function() {
        setLastColor.call(this_obj);
      });
      canvas.addEventListener("contextmenu", function(event) {
        event.preventDefault();
        chooseColor.call(this_obj);
      });

      this.init = function(container) {
        container.appendChild(canvas);
        paintComponent();
      }

      this.setRGBColor = function(red, green, blue) {
        color.setColor(red, green, blue);
        paintComponent();
      }

      this.setColor = function(c) {
        color = c;
        paintComponent();
      }

      /*Left click or tap*/
      function setLastColor() {
        this.setColor(lastcolors[lastcolors.length - 1]);
      }

      /*Right click or long hold (like open the context menu)*/
      function chooseColor() {
        ccm.getNewColor(color, function() {
          this_obj.setColor.call(this_obj, lastcolors[lastcolors.length - 1]);
        });
      }

      function paintComponent() {
        context.clearRect(0, 0, canvas.width, canvas.height);
        context.fillStyle = color.toHexString();
        context.beginPath();
        context.arc(80, 80, 70, 0, 2 * Math.PI);
        context.fill();
      }
    }

    function Color() {
      var r = 0;
      var g = 0;
      var b = 0;

      this.setColor = function(red, green, blue) {
        r = red;
        g = green;
        b = blue;
      }

      this.toHexString = function() {
        return "#" + addZero(r.toString(16)) + addZero(g.toString(16)) + addZero(b.toString(16));
      }

      function addZero(n) {
        if(n.length == 1) {
          return "0" + n;
        }
        else {
          return n;
        }
      }
    }

    initGUI();
    </script>
    <noscript>
      Das Senden an den PHP Server funktioniert nur mit JavaScript. Generell ist alles was mit JavaScript ist cool, also mach es an! (PS: bitte sage nicht, dass
man den Inhalt eines Textfeldes auch ohne JavaScript hätte senden können, das weiß ich. Aber spätestens hier beim Muster brauche ich es eh.)
    </noscript>
  </body>
</html>
